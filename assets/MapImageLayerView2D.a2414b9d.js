import{r as N,as as k,dU as B,dV as Z,dW as U,bU as W,$ as a,a0 as p,dX as z,bW as H,cJ as G,aP as X,dY as Y,a1 as j,cN as J,dZ as K,cT as q,d_ as ee,bQ as te,d$ as re,dL as ie,e0 as se,e1 as ae,e2 as oe,U as ne,c_ as pe,e3 as le,f as _,t as ue,e as me,e4 as ye,cu as de,d4 as he,s as ce,ds as fe,p as ge,R as V}from"./index.a2b594ae.js";import{t as we}from"./BitmapContainer.3a932641.js";import{f as ve,u as be}from"./LayerView.cda7cf95.js";import{a as xe}from"./BaseGraphicContainer.1fa0b98f.js";import{n as $e}from"./HighlightGraphicContainer.6281cf01.js";import{S as Ie}from"./ExportStrategy.6ef70e13.js";import{s as M,a as Pe}from"./drapedUtils.2cb5ce95.js";import{d as Se,s as Ee}from"./popupUtils.b17f3311.js";import{i as Ne}from"./RefreshableLayerView.6c560e1f.js";import"./WGLContainer.22a0c4e4.js";import"./enums.c60b1dad.js";import"./utils.d12e2f8e.js";import"./Utils.2e3a7d75.js";import"./number.6e30c64a.js";import"./enums.9bd521fc.js";import"./Texture.ccb8779a.js";import"./VertexElementDescriptor.2400a91d.js";import"./MaterialKey.0b3d0eb1.js";import"./alignmentUtils.84250e5d.js";import"./VertexArrayObject.4f327ffb.js";import"./ProgramTemplate.f984cffb.js";import"./StyleDefinition.d46cb482.js";import"./config.ded6d251.js";import"./GeometryUtils.b4d0dc88.js";import"./earcut.f65e2fcc.js";import"./CIMSymbolHelper.9d471047.js";import"./BidiEngine.95523203.js";import"./GeometryUtils.f3664fe1.js";import"./normalizeUtilsSync.924df729.js";import"./projectionSupport.19c2bea2.js";import"./json.8bd707cf.js";import"./FeatureContainer.3d3ea08e.js";import"./TileContainer.65a061dc.js";import"./visualVariablesUtils.3b6fdf98.js";import"./visualVariablesUtils.e34b6b98.js";import"./Matcher.d151d078.js";import"./tileUtils.40106882.js";import"./TileClipper.5b46af68.js";import"./Geometry.f2d62961.js";import"./cimAnalyzer.92f51743.js";import"./ExpandedCIM.ec020537.js";import"./schemaUtils.a0315d44.js";import"./createSymbolSchema.6b64f055.js";import"./MD5.7323a015.js";import"./util.6c0fb4fc.js";import"./ComputedAttributeStorage.40f17c59.js";import"./centroid.87389c2d.js";import"./vec3f32.ca7a14c1.js";import"./Bitmap.e9c63c63.js";const A=t=>t.spatialReference.wkid||JSON.stringify(t.spatialReference);function Oe(t,e){const{dpi:r,gdbVersion:s,geometry:i,geometryPrecision:n,height:m,layerOption:l,mapExtent:o,maxAllowableOffset:h,returnFieldName:y,returnGeometry:c,returnUnformattedValues:g,returnZ:P,spatialReference:$,timeExtent:I,tolerance:u,width:x}=t.toJSON(),{dynamicLayers:w,layerDefs:f,layerIds:v}=je(t),F=e&&N(e.geometry)?e.geometry:null,b={geometryPrecision:n,maxAllowableOffset:h,returnFieldName:y,returnGeometry:c,returnUnformattedValues:g,returnZ:P,tolerance:u},E=F&&F.toJSON()||i;if(b.imageDisplay=`${x},${m},${r}`,s&&(b.gdbVersion=s),E&&(delete E.spatialReference,b.geometry=JSON.stringify(E),b.geometryType=k(E)),$?b.sr=$.wkid||JSON.stringify($):E&&E.spatialReference?b.sr=A(E):o&&o.spatialReference&&(b.sr=A(o)),b.time=I?[I.start,I.end].join(","):null,o){const{xmin:L,ymin:Q,xmax:T,ymax:D}=o;b.mapExtent=`${L},${Q},${T},${D}`}return f&&(b.layerDefs=f),w&&!f&&(b.dynamicLayers=w),b.layers=l==="popup"?"visible":l,v&&!w&&(b.layers+=`:${v.join(",")}`),b}function je(t){var $,I;const{mapExtent:e,floors:r,width:s,sublayers:i,layerIds:n,layerOption:m,gdbVersion:l}=t,o=(I=($=i==null?void 0:i.find(u=>u.layer!=null))==null?void 0:$.layer)==null?void 0:I.serviceSublayers,h=m==="popup",y={},c=B({extent:e,width:s,spatialReference:e==null?void 0:e.spatialReference}),g=[],P=u=>{const x=c===0,w=u.minScale===0||c<=u.minScale,f=u.maxScale===0||c>=u.maxScale;if(u.visible&&(x||w&&f))if(u.sublayers)u.sublayers.forEach(P);else{if((n==null?void 0:n.includes(u.id))===!1||h&&(!u.popupTemplate||!u.popupEnabled))return;g.unshift(u)}};if(i==null||i.forEach(P),i&&!g.length)y.layerIds=[];else{const u=Z(g,o,l),x=g.map(w=>{const f=U(r,w);return w.toExportImageJSON(f)});if(u)y.dynamicLayers=JSON.stringify(x);else{if(i){let f=g.map(({id:v})=>v);n&&(f=f.filter(v=>n.includes(v))),y.layerIds=f}else n!=null&&n.length&&(y.layerIds=n);const w=Fe(r,g);if(N(w)&&w.length){const f={};for(const v of w)v.definitionExpression&&(f[v.id]=v.definitionExpression);Object.keys(f).length&&(y.layerDefs=JSON.stringify(f))}}}return y}function Fe(t,e){const r=!!(t!=null&&t.length),s=e.filter(i=>i.definitionExpression!=null||r&&i.floorInfo!=null);return s.length?s.map(i=>{const n=U(t,i),m=W(n,i.definitionExpression);return{id:i.id,definitionExpression:m}}):null}var R;let d=R=class extends J{constructor(t){super(t),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(t){return K(R,t)}};a([p({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),a([p()],d.prototype,"floors",void 0),a([p({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),a([p({types:z,json:{read:H,write:!0}})],d.prototype,"geometry",void 0),a([p({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),a([p({type:Number,json:{write:!0}})],d.prototype,"height",void 0),a([p({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),a([p({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),a([p({type:G,json:{write:!0}})],d.prototype,"mapExtent",void 0),a([p({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),a([p({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),a([p({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),a([p({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),a([p({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),a([p({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),a([p({type:X,json:{write:!0}})],d.prototype,"spatialReference",void 0),a([p()],d.prototype,"sublayers",void 0),a([p({type:Y,json:{write:!0}})],d.prototype,"timeExtent",void 0),a([p({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),a([p({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=R=a([j("esri.rest.support.IdentifyParameters")],d);const C=d;let S=class extends J{constructor(t){super(t),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(t,e){return q.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(t,e){if(!t)return;const{attributes:r,geometry:s}=t;r&&(e.attributes={...r}),N(s)&&(e.geometry=s.toJSON(),e.geometryType=re.toJSON(s.type))}};a([p({type:String,json:{write:!0}})],S.prototype,"displayFieldName",void 0),a([p({type:q})],S.prototype,"feature",void 0),a([ee("feature",["attributes","geometry"])],S.prototype,"readFeature",null),a([te("feature")],S.prototype,"writeFeature",null),a([p({type:Number,json:{write:!0}})],S.prototype,"layerId",void 0),a([p({type:String,json:{write:!0}})],S.prototype,"layerName",void 0),S=a([j("esri.rest.support.IdentifyResult")],S);const Re=S;async function Ue(t,e,r){const s=(e=Ve(e)).geometry?[e.geometry]:[],i=ie(t);return i.path+="/identify",se(s).then(n=>{const m=Oe(e,{geometry:n&&n[0]}),l=ae({...i.query,f:"json",...m}),o=oe(l,r);return ne(i.path,o).then(_e).then(h=>Me(h,e.sublayers))})}function _e(t){const e=t.data;e.results=e.results||[];const r={results:[]};return r.results=e.results.map(s=>Re.fromJSON(s)),r}function Ve(t){return t=C.from(t)}function Me(t,e){if(!(e!=null&&e.length))return t;const r=new Map;function s(i){r.set(i.id,i),i.sublayers&&i.sublayers.forEach(s)}e.forEach(s);for(const i of t.results)i.feature.sourceLayer=r.get(i.layerId);return t}const Ae=t=>{let e=class extends t{initialize(){this.exportImageParameters=new le({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var r;return(r=this.exportImageParameters)==null||r.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(r,s){var m,l,o,h,y,c;const{layer:i}=this;if(!r)throw new _("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const n=(o=(l=(m=this.layer.capabilities)==null?void 0:m.operations)==null?void 0:l.supportsQuery)!=null?o:!0;if(!(((c=(y=(h=this.layer.capabilities)==null?void 0:h.operations)==null?void 0:y.supportsIdentify)!=null?c:!0)&&this.layer.version>=10.5)&&!n)throw new _("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:i});return n?this._fetchPopupFeaturesUsingQueries(r,s):this._fetchPopupFeaturesUsingIdentify(r,s)}canResume(){var r;return!!super.canResume()&&!((r=this.timeExtent)!=null&&r.isEmpty)}async _fetchPopupFeaturesUsingIdentify(r,s){const i=await this._createIdentifyParameters(r,s);if(ue(i))return[];const{results:n}=await Ue(this.layer.parsedUrl,i);return n.map(m=>m.feature)}async _createIdentifyParameters(r,s){var I,u;const{floors:i,spatialReference:n,scale:m}=this.view,l=N(s)?s.event:null,o=await this._collectPopupProviders(this.layer.sublayers,m,s);if(!o.length)return null;await Promise.all(o.map(({sublayer:x})=>x.load().catch(()=>{})));const h=Math.min(me("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((x,w)=>w.renderer?M({renderer:w.renderer,event:l}):x,2)),y=this.createFetchPopupFeaturesQueryGeometry(r,h),c=ye(m,n),g=Math.round(y.width/c),P=new G({xmin:y.center.x-c*g,ymin:y.center.y-c*g,xmax:y.center.x+c*g,ymax:y.center.y+c*g,spatialReference:y.spatialReference}),$=((u=(I=this.layer.capabilities)==null?void 0:I.operations)==null?void 0:u.supportsQuery)===!1||await new Promise(x=>{let w=!1;Promise.all(o.map(async({popupTemplate:f})=>{if(f){const v=await this._loadArcadeModules(f);if(w)return;(v==null?void 0:v.arcadeUtils.hasGeometryOperations(f))&&(w=!0,x(!0))}})).finally(()=>x(!1))});return new C({floors:i,gdbVersion:this.layer.gdbVersion,geometry:r,height:g,layerOption:"popup",mapExtent:P,maxAllowableOffset:$?0:c,returnGeometry:!0,spatialReference:n,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:h,width:g})}async _fetchPopupFeaturesUsingQueries(r,s){const i=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,s),n=N(s)?s.event:null,m=i.map(async({sublayer:l,popupTemplate:o})=>{var P,$;await l.load().catch(()=>{});const h=l.createQuery(),y=M({renderer:l.renderer,event:n}),c=this.createFetchPopupFeaturesQueryGeometry(r,y);if(h.geometry=c,h.outFields=await Se(l,o),"floors"in this.view){const I=($=(P=this.view)==null?void 0:P.floors)==null?void 0:$.clone(),u=U(I,l);N(u)&&(h.where=h.where?`(${h.where}) AND (${u})`:u)}const g=await this._loadArcadeModules(o);return g&&g.arcadeUtils.hasGeometryOperations(o)||(h.maxAllowableOffset=c.width/y),(await l.queryFeatures(h)).features});return(await de(m)).reduce((l,o)=>o.value?[...l,...o.value]:l,[]).filter(l=>l!=null)}async _collectPopupProviders(r,s,i){const n=[],m=async o=>{const h=o.minScale===0||s<=o.minScale,y=o.maxScale===0||s>=o.maxScale;if(o.visible&&h&&y){if(o.sublayers)o.sublayers.forEach(m);else if(o.popupEnabled){const c=Ee(o,{...i,defaultPopupTemplateEnabled:!1});N(c)&&n.unshift({sublayer:o,popupTemplate:c})}}},l=r.toArray().reverse().map(m);return await Promise.all(l),n}_loadArcadeModules(r){var s;if(((s=r.expressionInfos)==null?void 0:s.length)||Array.isArray(r.content)&&r.content.some(i=>i.type==="expression"))return he()}};return a([p()],e.prototype,"exportImageParameters",void 0),a([p({readOnly:!0})],e.prototype,"exportImageVersion",null),a([p()],e.prototype,"layer",void 0),a([p()],e.prototype,"suspended",void 0),a([p(pe)],e.prototype,"timeExtent",void 0),e=a([j("esri.views.layers.MapImageLayerView")],e),e},Ge=ce.getLogger("esri.views.2d.layers.MapImageLayerView2D");let O=class extends Ae(Ne(ve(be))){constructor(){super(...arguments),this._highlightGraphics=new fe}update(t){this.strategy.update(t).catch(e=>{ge(e)||Ge.error(e)})}attach(){const{imageMaxWidth:t,imageMaxHeight:e,version:r}=this.layer,s=r>=10.3,i=r>=10;this._bitmapContainer=new we,this.container.addChild(this._bitmapContainer);const n=new xe({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new $e(this.view.featuresTilingScheme)});this.container.addChild(n.container),this.strategy=new Ie({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:t,imageMaxHeight:e,imageRotationSupported:s,imageNormalizationSupported:i,hidpi:!0}),this.handles.add(V(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(V(()=>{var m;return(m=this.view)==null?void 0:m.floors},()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(t,e){return this._highlightGraphics.add(t),{remove:()=>{this._highlightGraphics.remove(t)}}}supportsSpatialReference(t){return this.layer.serviceSupportsSpatialReference(t)}createFetchPopupFeaturesQueryGeometry(t,e){return Pe(t,e,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(t,e,r,s){return this.layer.fetchImage(t,e,r,{timeExtent:this.timeExtent,floors:this.view.floors,...s})}};a([p()],O.prototype,"strategy",void 0),a([p()],O.prototype,"updating",void 0),O=a([j("esri.views.2d.layers.MapImageLayerView2D")],O);const _t=O;export{_t as default};
